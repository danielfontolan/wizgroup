<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Wizgroup - Agendador de Atividades</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; margin: 15px; font-size: 14px; background-color: #f8f9fa; color: #343a40; }
        .container { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
    <script src="https://chat.wizgroup.com.br/packs/js/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h3>Agendar Atividade</h3>
        <p id="lead-info">Carregando dados do lead...</p>
        <form id="schedule-form">
            <div class="form-group">
                <label for="tipo-evento">Tipo de Evento</label>
                <select id="tipo-evento" name="tipo-evento" required>
                    <option value="Entrevista">Entrevista</option>
                    <option value="Follow-up">Follow-up (Tarefa)</option>
                </select>
            </div>
            <div class="form-group" id="subtipo-group">
                <label for="subtipo-entrevista">Tipo de Entrevista</label>
                <select id="subtipo-entrevista" name="subtipo-entrevista">
                    <option value="Online">Online</option>
                    <option value="Presencial">Presencial</option>
                </select>
            </div>
            <div class="form-group">
                <label for="event-date">Data</label>
                <input type="date" id="event-date" name="event-date" required>
            </div>
            <div class="form-group">
                <label for="event-time">Hora</label>
                <input type="time" id="event-time" name="event-time" required>
            </div>
            <div class="form-group">
                <label for="event-title">Título / Objetivo</label>
                <input type="text" id="event-title" name="event-title" required>
            </div>
            <button type="submit">Agendar</button>
        </form>
        <p id="status"></p>
    </div>
    
<script>
    // Objeto para armazenar os dados contextuais que receberemos do Chatwoot
    let context = {};

    console.log('Página agendador.html carregada. Ouvindo por mensagens do Chatwoot...');

    // Adiciona um "ouvinte" para o evento 'message'
    window.addEventListener('message', function (event) {
        
        // Medida de segurança: só aceita mensagens vindas da sua instância do Chatwoot
        if (event.origin !== "https://chat.wizgroup.com.br") {
            console.log('Mensagem ignorada de origem não autorizada:', event.origin);
            return;
        }

        console.log('--- NOVA MENSAGEM RECEBIDA ---');

        // Passo 1: Verifica se o dado é uma string (necessário para o JSON.parse)
        if (typeof event.data !== 'string') {
            console.log('Mensagem ignorada: o dado não é uma string.', event.data);
            return;
        }

        try {
            const eventData = JSON.parse(event.data);
            console.log('Passo 2: Mensagem convertida para JSON com sucesso:', eventData);

            // Passo 3: Verifica se o evento é o que estamos procurando
            if (eventData.event === 'set:contact') {
                console.log('Passo 3: SUCESSO! Evento "set:contact" encontrado.');

                // Passo 4: Verifica se os dados do contato existem dentro do evento
                if (eventData.data && eventData.data.contact) {
                    console.log('Passo 4: SUCESSO! Objeto "contact" encontrado dentro dos dados.');
                    
                    // Armazena os dados no nosso objeto de contexto
                    context.contact = eventData.data.contact;
                    context.user = eventData.data.currentAgent;

                    // Atualiza a interface com os dados recebidos
                    const leadName = context.contact.name || 'Contato sem nome';
                    document.getElementById('lead-info').innerText = `Agendando para: ${leadName}`;
                    document.getElementById('event-title').value = `Conversar com ${leadName}`;
                    console.log('Passo 5: SUCESSO! Interface atualizada com o nome do lead.');

                } else {
                    console.error('ERRO no Passo 4: O evento é "set:contact", mas a estrutura eventData.data.contact não foi encontrada.');
                }
            } else {
                console.log('Passo 3: Mensagem ignorada, não é o evento "set:contact". Evento recebido:', eventData.event);
            }

        } catch (error) {
            console.error('ERRO no Passo 2: Falha ao tentar converter a mensagem para JSON. Mensagem original:', event.data, 'Erro:', error);
        }
    });

    // A lógica do formulário abaixo não precisa de alterações
    // ---------------------------------------------------
    const tipoEventoSelect = document.getElementById('tipo-evento');
    const subtipoGroup = document.getElementById('subtipo-group');
    tipoEventoSelect.addEventListener('change', function() {
        subtipoGroup.style.display = this.value === 'Entrevista' ? 'block' : 'none';
    });
    document.getElementById('schedule-form').addEventListener('submit', function(event) {
        event.preventDefault(); 
        const statusEl = document.getElementById('status');
        statusEl.innerText = 'Enviando agendamento...';
        const formData = {
            contact: context.contact, user: context.user,
            tipoEvento: document.getElementById('tipo-evento').value,
            subtipoEntrevista: document.getElementById('subtipo-entrevista').value,
            data: document.getElementById('event-date').value,
            hora: document.getElementById('event-time').value,
            titulo: document.getElementById('event-title').value,
        };
        const n8nWebhookUrl = 'https://SEU_DOMINIO_N8N/webhook/SEU_ID_WEBHOOK';
        fetch(n8nWebhookUrl, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                statusEl.innerText = 'Agendamento realizado com sucesso!';
                statusEl.style.color = 'green';
            } else {
                statusEl.innerText = 'Ocorreu um erro ao agendar.';
                statusEl.style.color = 'red';
            }
        }).catch(error => {
            statusEl.innerText = 'Erro de comunicação com o servidor.';
            statusEl.style.color = 'red';
            console.error('Erro no fetch:', error);
        });
    });
</script>
</body>
</html>
