<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Wizgroup - Agendador de Atividades</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; margin: 15px; font-size: 14px; background-color: #f8f9fa; color: #343a40; }
        .container { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
    <script src="https://chat.wizgroup.com.br/packs/js/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h3>Agendar Atividade</h3>
        <p id="lead-info">Carregando dados do lead...</p>
        <form id="schedule-form">
            <div class="form-group">
                <label for="tipo-evento">Tipo de Evento</label>
                <select id="tipo-evento" name="tipo-evento" required>
                    <option value="Entrevista">Entrevista</option>
                    <option value="Follow-up">Follow-up (Tarefa)</option>
                </select>
            </div>
            <div class="form-group" id="subtipo-group">
                <label for="subtipo-entrevista">Tipo de Entrevista</label>
                <select id="subtipo-entrevista" name="subtipo-entrevista">
                    <option value="Online">Online</option>
                    <option value="Presencial">Presencial</option>
                </select>
            </div>
            <div class="form-group">
                <label for="event-date">Data</label>
                <input type="date" id="event-date" name="event-date" required>
            </div>
            <div class="form-group">
                <label for="event-time">Hora</label>
                <input type="time" id="event-time" name="event-time" required>
            </div>
            <div class="form-group">
                <label for="event-title">Título / Objetivo</label>
                <input type="text" id="event-title" name="event-title" required>
            </div>
            <button type="submit">Agendar</button>
        </form>
        <p id="status"></p>
    </div>
    
<script>
    // Objeto para armazenar os dados contextuais
    let context = {};

    console.log('Página agendador.html carregada. Verificando o estado do SDK.');

    // --- NOVA LÓGICA DE INICIALIZAÇÃO ROBUSTA ---

    // Esta é a função principal que executa a lógica do nosso app
    function initializeApp(sdk) {
        console.log('SDK detectado. Inicializando a aplicação...');
        
        // Pega os dados do contato
        sdk.getContact().then(contactData => {
            console.log('Dados do Contato recebidos:', contactData);
            context.contact = contactData;
            document.getElementById('lead-info').innerText = `Agendando para: ${contactData.name || 'Contato sem nome'}`;
            document.getElementById('event-title').value = `Conversar com ${contactData.name}`;
        }).catch(error => {
            console.error('ERRO AO OBTER DADOS DO CONTATO:', error);
            document.getElementById('status').innerText = 'Falha ao obter dados do Contato.';
        });

        // Pega os dados do usuário (vendedor)
        sdk.getUser().then(userData => {
            console.log('Dados do Usuário (vendedor) recebidos:', userData);
            context.user = userData;
        }).catch(error => {
            console.error('ERRO AO OBTER DADOS DO USUÁRIO:', error);
            document.getElementById('status').innerText = 'Falha ao obter dados do Vendedor.';
        });
    }

    // Função que será chamada quando o evento 'ready' for disparado
    function onChatwootReady(event) {
        console.log('Evento "chatwoot:ready" RECEBIDO!');
        // O SDK passa a si mesmo como um detalhe do evento
        initializeApp(event.detail);
    }

    // Verifica se o SDK já está pronto quando nosso script roda
    if (window.chatwootSDK) {
        initializeApp(window.chatwootSDK);
    } else {
        // Se não, espera pelo evento 'ready' para inicializar
        window.addEventListener('chatwoot:ready', onChatwootReady, false);
    }

    // --- FIM DA LÓGICA DE INICIALIZAÇÃO ---


    // A lógica do formulário abaixo permanece a mesma

    // Lógica para mostrar/ocultar o subtipo de entrevista
    const tipoEventoSelect = document.getElementById('tipo-evento');
    const subtipoGroup = document.getElementById('subtipo-group');
    tipoEventoSelect.addEventListener('change', function() {
        subtipoGroup.style.display = this.value === 'Entrevista' ? 'block' : 'none';
    });

    // Executa quando o formulário é enviado
    document.getElementById('schedule-form').addEventListener('submit', function(event) {
        event.preventDefault(); 

        const statusEl = document.getElementById('status');
        statusEl.innerText = 'Enviando agendamento...';

        const formData = {
            contact: context.contact,
            user: context.user,
            tipoEvento: document.getElementById('tipo-evento').value,
            subtipoEntrevista: document.getElementById('subtipo-entrevista').value,
            data: document.getElementById('event-date').value,
            hora: document.getElementById('event-time').value,
            titulo: document.getElementById('event-title').value,
        };
        
        // SUBSTITUA PELA URL DO SEU WEBHOOK DO N8N
        const n8nWebhookUrl = 'https://SEU_DOMINIO_N8N/webhook/SEU_ID_WEBHOOK';

        fetch(n8nWebhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusEl.innerText = 'Agendamento realizado com sucesso!';
                statusEl.style.color = 'green';
            } else {
                statusEl.innerText = 'Ocorreu um erro ao agendar.';
                statusEl.style.color = 'red';
            }
        })
        .catch(error => {
            statusEl.innerText = 'Erro de comunicação com o servidor.';
            statusEl.style.color = 'red';
            console.error('Erro no fetch:', error);
        });
    });
</script>
</body>
</html>
